define("widgets/utils/widgetModel",["lodash","compUtils"],function(e,t){"use strict";function i(e,i){var a=t.compFactory.getCompReactClass(i);return a&&a.publicState?a.publicState(null,e):{}}function a(t,a,n){var s={data:t.getCompData(a),fullData:t.getCompFullData(a),props:t.getCompProps(a)},o=t.getCompState(a);return e.isUndefined(o)||e.isEmpty(o)?i(s,n):o}function n(e,t){var i=e.getParentId(t),n=e.getCompStructure(i),s=a(e,i,n.componentType),o=n&&s&&n.components[s.currentIndex];return o&&o.id}function s(e,t){for(var i=t;i;){var a=e.getCompType(i);if(a===r||a===d)return i===n(e,i);i=e.getParentId(i)}return e.isDisplayed(t)}function o(t,i,a){return e.reduce(t,function(t,n){var s=i.getCompConnections(n),o=e.map(s,function(t){var i;return i="WixCodeConnectionItem"===t.type?e.assign({},t,{controllerId:a,config:null}):e.defaults({},t,{config:null}),{connection:i,compId:n}});return t.concat(o)},[])}var r="wysiwyg.viewer.components.BoxSlideShowSlide",d="wysiwyg.viewer.components.StripContainerSlideShowSlide";return{getCompModel:function(e,t){var i=e.getCompType(t),n=a(e,t,i);return{parent:e.getParentId(t),type:i,state:n,layout:e.getCompLayout(t),design:e.getCompDesign(t),isDisplayed:s(e,t),id:e.getCompName(t),data:e.getCompData(t),fullData:e.getCompFullData(t),props:e.getCompProps(t),events:[]}},getConnectionsModel:function(t,i,a){var n=o(i,t,a);return e(n).groupBy("connection.controllerId").mapValues(function(t){return e(t).groupBy("connection.role").mapValues(function(t){return e(t).keyBy("compId").mapValues("connection.config").value()}).value()}).value()}}}),define("widgets/utils/wixCodeRemoteModelService",["lodash","platformUtils","siteUtils","widgets/utils/widgetModel"],function(e,t,i,a){"use strict";var n=t.RemoteModelInterface;return{generateRemoteModelInterface:function(t,s,o,r,d,u,c,p,l){var g=new n(void 0,p);return e.forEach(s,function(i){var n=a.getCompModel(t,i),s=e.get(n.data,"widgetId");e.assign(n,{publicAPI:d[s]}),g.addComponent(i,n)}),g.addSiteStructure(o),g.addNavigation(r),g.addConnections(a.getConnectionsModel(t,s,l)),g.addEventTypes(i.constants.ACTION_TYPES),g.addSiteMemberData(c),g.addSessionInfoProp(u),g},createRemoteModelInterface:function(e,t){return new n(e,t)}}}),define("widgets/core/widgetDataHelper",["lodash"],function(e){"use strict";return{registerWidgetHandler:function(t,i){e.set(t,"widgetHandler",i)},getWidgetHandler:function(t){return e.get(t,"widgetHandler")}}}),define("widgets/core/dataResolvers/pageLinkDataResolver",["lodash"],function(e){"use strict";function t(t,i){if("#"===t)return"#"+i.getMainPageId();var a=i.findDataOnMasterPageByPredicate(function(e){return e.pageUriSEO===t.replace("#","")}),n=e.get(a,"id",t);return e.startsWith(n,"#")?n:"#"+n}function i(t,i){var a=e.compact(t.replace(/^#/,"").split("/")),n=e.findKey(i.getRouters(),{prefix:a[0]});if(n)return{type:"DynamicPageLink",routerId:n,innerRoute:a.slice(1).join("/")}}function a(t){var i=[],n=e.get(t,"link");n&&i.push(n);var s=e.get(t,"linkList");return s&&(i=i.concat(s)),e.forEach(t,function(t){e.isObject(t)&&(i=i.concat(a(t)))}),i}function n(t,i){var a=e.reduce(i.columns,function(e,t){return t.linkPath&&e.push(t.linkPath),e},[]),n=[];return a.length>0&&e.forEach(t.rows,function(t){e.forEach(a,function(i){var a=i+"_linkObj",s=e.get(t,a);e.isUndefined(s)||n.push(s)})}),n}return{resolve:function(s,o,r){var d,u=o.getSiteData();return d="Grid"===s.type?n(s,r):a(s),e.forEach(d,function(a){var n=a.type,s=a.pageId;if(("PageLink"===n||"AnchorLink"===n)&&e.isString(s)){var o=i(a.pageId,u);o?(e.assign(a,o),delete a.pageId):a.pageId=t(s,u)}}),s}}}),define("widgets/core/dataResolvers/emptyImageDataResolver",["lodash"],function(e){"use strict";function t(t){return t.uri?t:e.assign({},t,{uri:i})}var i="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==";return{resolve:function(i){return"Image"===i.type?t(i):"ImageList"===i.type?e.assign({},i,{items:i.items&&i.items.map(t)}):i}}}),define("widgets/core/widgetDataResolvers",["lodash","widgets/core/dataResolvers/pageLinkDataResolver","widgets/core/dataResolvers/emptyImageDataResolver"],function(e,t,i){"use strict";var a=[t,i];return{resolve:function(t,i,n){return e.forEach(a,function(e){t=e.resolve(t,i,n)}),t}}}),define("widgets/core/modelBuilderDataHelper",["lodash"],function(e){"use strict";var t={PAGE:"Page",POPUP:"Popup",UNKNOWN:"Unknown"},i=["Page","AppPage"];return{getApi:function(e){return{fetchData:e.getDataByQuery.bind(e),fetchSiteStructure:e.getSiteStructureForRmi.bind(e),fetchNavigationData:e.getNavigationDataRmi.bind(e),fetchPublicAPI:e.getPublicAPIDataForRmi.bind(e),fetchSessionInfo:e.getSessionInfoForRmi.bind(e),fetchSiteMemberData:e.getSMbySiteExtensionInstanceForRmi.bind(e)}},getWidgetType:function(a){return e.includes(i,e.get(a,"type"))?e.get(a,"isPopup")?t.POPUP:t.PAGE:t.UNKNOWN},WIDGET_TYPES:t}}),define("widgets/core/modelBuilder",["lodash","coreUtils","widgets/utils/wixCodeRemoteModelService","widgets/core/modelBuilderDataHelper"],function(e,t,i,a){"use strict";function n(t,a,n,s,o,r,d,u){return e.mapValues(a,function(e,a){return i.generateRemoteModelInterface(t,e,s(),o(),r(),d(),u(),n,a)})}function s(t,i){var a=[d.PAGES_CONTAINER_ID,d.SITE_PAGES_ID],n=i(t,t);return e(n).omit([d.SITE_STRUCTURE_ID]).keys().difference(a).value()}function o(e,t){var i=t(e,e);return a.getWidgetType(i)===a.WIDGET_TYPES.PAGE}function r(i,a,n){var r=t.siteConstants.MASTER_PAGE_ID,d=s(r,a),u=e.without(i,r);return e.transform(u,function(e,t){e[t]=s(t,a),o(t,n)&&(e[t]=e[t].concat(d))},{})}var d=t.siteConstants;return{build:function(e,t,i,s,o){var d=a.getApi(t);return n(e,r(i,o,d.fetchData),s,d.fetchSiteStructure,d.fetchNavigationData,d.fetchPublicAPI,d.fetchSessionInfo,d.fetchSiteMemberData)}}}),define("widgets/messages/messageBuilder",[],function(){"use strict";return{loadWidgetsMessage:function(e,t,i,a){return{type:"load_widgets",sdkParameters:{referrer:"undefined"==typeof window?"":window.document.referrer},widgets:e,rootIds:i,routersMap:t||{},popupContexts:a||{}}},loadUserCodesMessage:function(e,t){return{type:"load_user_code",widgets:e,rootIds:t}},initWidgetsMessage:function(e){return{type:"init_widgets",contexts:e}},startWidgetsMessage:function(e,t){return{type:"start_widgets",contexts:e,siteInfo:t}},stopWidgetsMessage:function(e){return{type:"stop_widgets",widgetIds:e}},updateWidgetMessage:function(e,t){return{type:"update",contextId:e,updates:t}},updateSiteMemberData:function(e,t){return{contextId:e,type:"update_site_member",updates:t}},updateSessionInfo:function(e,t){return{contextId:e,type:"update_session_info",updates:t}},triggerOnRenderMessage:function(e){return{intent:"WIX_CODE",type:"trigger_onRender",contextId:e}},triggerUserFunctionMessage:function(e,t,i){return{intent:"WIX_CODE",type:"wix_code_run_user_function",contextId:e,callbackId:t.callbackId,compId:t.compId,event:i}},updateWixCodeModelDataAfterLoginMessage:function(e,t){return{type:"update_wix_code_model_data_after_login",rootIds:t,widgets:e}}}}),define("widgets/core/RemoteWidgetHandlerProxy",["lodash","mobx","core","utils","widgets/core/widgetDataResolvers","widgets/core/modelBuilder","widgets/messages/messageBuilder"],function(e,t,i,a,n,s,o){"use strict";function r(t,i,a,n){({data:this._runtimeDal.setCompData.bind(this._runtimeDal),design:this._runtimeDal.setCompDesign.bind(this._runtimeDal),props:this._runtimeDal.setCompProps.bind(this._runtimeDal),layout:this._runtimeDal.updateCompLayout.bind(this._runtimeDal),registerEvent:d.bind(this)})[i](t,a),e.isFunction(this._onUpdateCallback)&&this._onUpdateCallback(n)}function d(e,t){var i={action:{type:"comp",name:t.eventType,sourceId:e},behavior:{type:"widget",targetId:t.contextId,params:{callbackId:t.callbackId,compId:e},name:"runCode"}};this._runtimeDal.addActionsAndBehaviors(e,i)}function u(e){var t=this._siteAPI.getSiteDataAPI().document,i=t.getAllCompsUnderRoot.bind(t);return s.build(this._siteAPI.getRuntimeDal(),this._siteAPI.getSiteData(),e,r.bind(this),i)}function c(){return{deviceType:this._siteAPI.getSiteData().isMobileView()?"mobile":"desktop"}}function p(e,t){this._actionQueue.addItem(function(){this.isWidgetReady(e.contextId)?this.handleCommand(e,t):p.call(this,e,t)}.bind(this))}function l(e){if(!this._isFlushingPendingCommands){var t=this;this._isFlushingPendingCommands=!0;var i=function(){t._isFlushingPendingCommands=!1,t._actionQueue.flush(),g(t._commandsFlushListeners)};e?i():a.animationFrame.request(i)}}function g(t){e.forEach(t,function(e){return e()})}function f(e,t){this._runtimeDal=e.getRuntimeDal(),this._siteAPI=e,this._displayedDal=e.getDisplayedDAL(),this._pointers=e.getPointers(),this._remoteModelInterfaces={},this._onUpdateCallback=t,this._receivedChanges=void 0,this._isFlushingPendingCommands=!1,this._commandsFlushListeners=[],this._actionQueue=e.getSiteDataAPI().getActionQueue()}function m(e){return this._remoteModelInterfaces[e]}function h(t){var i=e.merge(e.pick(t,"item"),e.pickBy(t,e.negate(e.isObject)));return i.nativeEvent=e.pickBy(t.nativeEvent,e.negate(e.isObject)),t.data&&(i.data=t.data),i}function v(t,i,a,s){var o=e.assign({},i.getCompData(a),s),r=i.getCompProps(a);return n.resolve(o,t,r)}var I={State:"stateChanged",Data:"dataChanged",Design:"designChanged",Props:"propsChanged",EventRegister:"registerEvent",Layout:"layoutChanged",Behavior:"executeBehavior"},y={WidgetReady:"widget_ready"};return f.prototype.initWidgets=function(e){var t=o.initWidgetsMessage(e);this._sendMessage(t)},f.prototype.startWidgets=function(t){if(!e.isEmpty(t)){e.assign(this._remoteModelInterfaces,u.call(this,t));var i=e.mapValues(this._remoteModelInterfaces,function(e){return e.toJson()}),a=c.call(this),n=o.startWidgetsMessage(e.pick(i,t),a);this._sendMessage(n)}},f.prototype.loadUserCode=function(e,t){var i=o.loadUserCodesMessage(e,t);this._sendMessage(i)},f.prototype.updateWixCodeModelDataAfterLogin=function(e,t){var i=o.updateWixCodeModelDataAfterLoginMessage(e,t);this._sendMessage(i)},f.prototype.loadWidgets=function(t,i){this.loadUserCode(t,i);var a=e(i).transform(function(e,t){e[t]=this._runtimeDal.getPopupContext(t)}.bind(this),{}).omitBy(e.isUndefined).value(),n=o.loadWidgetsMessage(t,this._siteAPI.getSiteData().getRouters(),i,a);this._sendMessage(n)},f.prototype.getActiveWidgetIds=function(){return e.keys(this._remoteModelInterfaces)},f.prototype.stopWidgets=function(t){if(!e.isEmpty(t)){e.forEach(t,function(e){delete this._remoteModelInterfaces[e];var t=this._pointers.platform.getPlatformWidgetStatePointer(e);this._displayedDal.set(t,!1)}.bind(this));var i=o.stopWidgetsMessage(t);this._sendMessage(i)}},f.prototype.stopAllWidgets=function(){this.stopWidgets(e.keys(this._remoteModelInterfaces))},f.prototype.updateComponent=function(e){this._sendMessage(e)},f.prototype.handleWidgetUpdate=function(t){var i=e(t).keys().head(),a=e.pickBy(this._remoteModelInterfaces,function(t){return e.has(t.toJson(),["components",i])}),n=e.find(e.find(t));if(!e.isEmpty(a)&&!e.isEqual(this._receivedChanges,n)){var s=e(a).keys().head();a[s].updateModel(t);var r=o.updateWidgetMessage(s,t);this._sendMessage(r)}},f.prototype.handleSiteMemberUpdate=function(t){e.forEach(this._remoteModelInterfaces,function(e,i){e.addSiteMemberData(t);var a=o.updateSiteMemberData(i,t);this._sendMessage(a)}.bind(this))},f.prototype.handleSvSessionUpdate=function(t){e.forEach(this._remoteModelInterfaces,function(e,i){e.addSessionInfoProp(t);var a=o.updateSessionInfo(i,{svSession:t});this._sendMessage(a)}.bind(this))},f.prototype.handleRemoteMessage=function(e){switch(e.type){case y.WidgetReady:if(m.call(this,e.widgetId)){var i=this._pointers.platform.getPlatformWidgetStatePointer(e.widgetId);t.runInAction(function(){this._displayedDal.set(i,!0),l.call(this,!0)}.bind(this))}}},f.prototype.onCommand=function(e,t){p.call(this,e,t),this.isWidgetReady(e.contextId)&&l.call(this,e.command===I.EventRegister)},f.prototype.handleCommand=function(e,t){this._receivedChanges=e.data;var a=this._remoteModelInterfaces[e.contextId];if(a){switch(e.command){case I.State:a.setState(e.compId,e.data);break;case I.Data:e.data=v(this._siteAPI,this._runtimeDal,e.compId,e.data),a.setData(e.compId,e.data);break;case I.Design:a.setDesign(e.compId,e.data);break;case I.Layout:a.setLayout(e.compId,e.data);break;case I.Props:a.setProps(e.compId,e.data,t);break;case I.EventRegister:a.registerEvent(e.contextId,e.compId,e.data.eventType,e.data.callbackId);break;case I.Behavior:var n=e.data,s={group:"command",callback:t};i.behaviorsService.handleBehaviors(this._siteAPI,[n],s,n.type)}this._receivedChanges=void 0}},f.prototype.handleEvent=function(e,t,i,a){var n;switch(t){case"runCode":n=o.triggerUserFunctionMessage(e,i,h(a));break;case"onRendered":n=o.triggerOnRenderMessage(e)}this._sendMessage(n)},f.prototype.isWidgetReady=function(e){var t=this._pointers.platform.getPlatformWidgetStatePointer(e);return!!this._displayedDal.get(t)},f.prototype._sendMessage=function(e){this._siteAPI.getWixCodeAppApi().sendMessage(e)},f.prototype.getAppsIframe=function(){return this._siteAPI.getWixCodeAppApi().getAppsIframe()},f.prototype.registerCommandsFlushedListener=function(t){if(!e.isFunction(t))throw new TypeError("The callback provided is not a function.");this._commandsFlushListeners.push(t)},f}),define("widgets/core/semiNativeLocalHandlers",[],function(){"use strict";return{relayout:function(e,t,i){e.registerReLayoutPending(i),e.reLayout()}}}),define("widgets/core/semiNativeLocalService",["remoteDOM","lodash","widgets/core/semiNativeLocalHandlers"],function(e,t,i){"use strict";return{initContext:function(a,n,s){var o=s.getSiteData(),r=t.mapValues(i,function(e){return t.partial(e,s)});e.setWindow(window),t.set(o,["semiNativeMessageQueues",a,"handlers"],[]),o.semiNativeMessageQueues[a].queueIndex=e.createMessageQueue({postMessage:function(e){n.sendMessage({intent:"WIX_CODE_RESPONSE",type:"OTW",data:e,contextId:a})},addEventListener:function(e,t){var i=function(e){e.data&&"WIX_CODE"===e.intent&&"OTW"===e.type&&t(e)};n.registerMessageHandler(i),o.semiNativeMessageQueues[a].handlers.push(i)}},null,r)},stopContext:function(e,i,a){var n=t.get(a,["semiNativeMessageQueues",e,"handlers"]);t.forEach(n,function(e){i.unregisterMessageHandler(e)}),delete a.semiNativeMessageQueues[e]}}}),define("widgets/core/semiNativeDataHelpers",["lodash","utils"],function(e,t){"use strict";function i(e,t,i){var a=e.getDataByQuery(t,i);return a&&a.content?JSON.parse(a.content):null}var a={APP:"APP",COMPONENT:"COMPONENT"};return{getStyleParams:function(i,a){var n=i.getAllTheme(),s=i.rendererModel.siteInfo.documentType,o=i.getDataByQuery("masterPage").characterSets,r=i.isVisualFocusEnabled(),d=t.styleUtils.getStyleDataToPassIntoApp(a,n,i.santaBase,s,o,i.serviceTopology,!0);return e.assign(d,{isVisualFocusEnabled:r})},getPublicData:function(e,t,n,s){var o={};return o[a.APP]=i(e,"tpaData-"+t,"masterPage"),o[a.COMPONENT]=i(e,n,s),o}}}),define("widgets/core/widgetService",["lodash","utils","widgets/utils/widgetModel","widgets/core/widgetDataHelper","widgets/core/RemoteWidgetHandlerProxy","widgets/core/semiNativeLocalService","widgets/core/semiNativeDataHelpers","coreUtils","wixCodeInit"],function(e,t,i,a,n,s,o,r,d){"use strict";function u(e){return!!e.getRenderFlag("initWixCode")}function c(t,a,n){if(e.includes(t.getAllRenderedRootIds(),a)){var s=t.getRuntimeDal(),o=t.getSiteDataAPI().document.getAllCompsUnderRoot(a,n),r=e(o).omit(["masterPage"]).mapValues(function(e){return i.getCompModel(s,e.id)}).value();P(t).handleWidgetUpdate(r)}}function p(t,i,a){var n=e.difference(t,e.map(i,"rootId"));return e.isEmpty(n)||(i=S(a,i,t),b(a,n)),i}function l(t,i){return e.map(t,function(t){return e.includes(i,t.rootId)?e.assign(t,{started:!0}):t})}function g(i,a,n){var s=i.getSiteData(),o=P(i);n=e.without(n,t.siteConstants.MASTER_PAGE_ID);var r=d.appsUtils.getApplications(s.getClientSpecMap(),n,s);if(e.isEmpty(r))return a;a=p(n,a,i);var u=e(a).reject({started:!0}).map("rootId").value();return e.isEmpty(u)?a:(o.startWidgets(u),a=l(a,u))}function f(t,i){var a=e.reject(t,function(t){return e.includes(i,t.rootId)});return e.map(a,"rootId")}function m(t,i){var a=e.filter(t,function(t){return e.includes(i,t.rootId)});return e.map(a,"rootId")}function h(t,i,a){var n=P(t);return e.isEmpty(a)||e.isEmpty(i)?i:(n.stopWidgets(a),e.reject(i,function(t){return e.includes(a,t.rootId)}))}function v(i,a){var n=[{id:i,json:a.getPageData(i)}];if(e.get(a.getDataByQuery(i),"isPopup"))return n;var s=t.siteConstants.MASTER_PAGE_ID;return n.concat({id:s,json:a.getMasterPageData()})}function I(t,i){return e(t).transform(function(t,i){e.assign(t,e.get(i,"data.connections_data"))},{}).values().flatMap(function(t){var a=i.resolveData(t,null,i.dataTypes.CONNECTIONS);return e.get(a,"items")}).groupBy("controllerId").value()}function y(e){return"platform.components.AppController"===e.componentType}function A(t,i){var a=e.filter(t,"json"),n=I(e.map(a,"json"),i);return e.flatMap(a,function(t){var a=r.dataUtils.getAllCompsInStructure(e.get(t,"json.structure"),!1,y);return e.map(a,function(a){var s=a.dataQuery.replace("#","");return e.omitBy({controllerBehaviors:e.get(i.getDataByQuery(a.behaviorQuery,t.id,i.dataTypes.BEHAVIORS),"items",[]),controllerData:i.getDataByQuery(s,t.id),controllerId:s,compId:a.id,connections:e.get(n,s)},e.isUndefined)})})}function _(t){return e(t).groupBy("controllerData.applicationId").mapValues(function(t){return e(t).keyBy("controllerId").mapValues(function(t){return e.pick(t,["controllerData","controllerBehaviors","connections","compId"])}).value()}).value()}function D(e,t){var i=e.getSiteData().widgetsStore;a.registerWidgetHandler(i,t)}function P(e){var t=e.getSiteData().widgetsStore;return a.getWidgetHandler(t)}function C(i,a){return e(i).without(t.siteConstants.MASTER_PAGE_ID).filter(a.getPageTitle.bind(a)).value()}function S(t,i,a){var n=t.getSiteData(),s=C(a,n);if(e(s).difference(e.map(i,"rootId")).thru(e.isEmpty).value())return i;var o=d.appsUtils.getApplications(n.getClientSpecMap(),s,n);if(e.isEmpty(o))return i;P(t).loadWidgets(o,s);var r=e.map(s,function(e){return{rootId:e}});return i.concat(r)}function M(t,i){var a=e.matchesProperty("componentType","platform.components.semiNativeComponent");return e(t).filter("json").flatMap(function(t){var n=r.dataUtils.getAllCompsInStructure(e.get(t,"json.structure"),!1,a);return e.map(n,function(a){var n=i.getDataByQuery(a.dataQuery.replace("#",""),t.id),s=e.find(i.getClientSpecMap(),"widgets."+n.widgetId);return{compId:a.id,instance:s&&s.instance,compData:n,styleParams:o.getStyleParams(i,a.styleId),publicData:o.getPublicData(i,n.applicationId,n.tpaData,t.id)}})}).value()}function w(t,i){var a=v(i,t),n=A(a,t),s=e.mapValues(_(n),function(e){return{controllers:e}}),o=M(a,t);return e.transform(o,function(i,a){var n=e.get(a,"compData.applicationId"),s=t.getClientSpecMapEntry(n).appDefinitionId;e.set(i,[s,"semiNativeComponents",a.compData.id],e.pick(a,["compId","compData","styleParams","publicData","instance"]))},s)}function b(i,a){var n=i.getSiteData(),o=e.without(a,t.siteConstants.MASTER_PAGE_ID),r=e(o).transform(function(e,t){e[t]=w(n,t)},{}).omitBy(e.isEmpty).value();e.isEmpty(r)||(e.forEach(o,function(t){e.some(r[t],"semiNativeComponents")&&s.initContext(t,R(i),i)}),P(i).initWidgets(r))}function R(e){return e.getWixCodeAppApi()}return{getWidgetHandler:P,syncAppsState:function(t,i){var a=e.without(t.getRootIdsWhichShouldBeRendered(),"masterPage");return u(t)?(i=h(t,i,f(i,a)),g(t,i,a)):h(t,i,a)},handleRuntimeDalCompChange:function(t,i,a){var n={dataChange:"data",propsChange:"props",stateChange:"state",layoutChange:"layout"},s=e.zipObject([n[a.type]],[a.value]),o=e.zipObject([i],[s]);P(t).handleWidgetUpdate(o)},handleDisplayedJsonUpdate:function(e,t,i){c(e,t,i)},handleSiteMemberUpdate:function(e){var t=e.getSiteData().getSMbySiteExtensionInstanceForRmi();P(e).handleSiteMemberUpdate(t)},handleSvSessionUpdate:function(e){var t=e.getSiteData().getSvSession();P(e).handleSvSessionUpdate(t)},updateCompsUnderRoot:c,createAndRegisterWidgetHandler:function(e,t){D(e,new n(e,t))},loadUserCode:function(t,i){var a=t.getSiteData(),n=C(i,a),s=d.appsUtils.getUserCodeDefinitions(a.getClientSpecMap(),n,a);e.isEmpty(s)||P(t).loadUserCode(s,n)},loadApps:S,initApps:b,stopApps:function(t,i,a){var n=m(i,a);return e(t.getAllRenderedRootIds()).intersection(n).thru(e.isEmpty).value()?i:(e.forEach(n,function(e){s.stopContext(e,R(t),t.getSiteData())}),h(t,i,n))},getContextInitData:w,registerWidgetMessageHandler:function(e,t){R(e).registerMessageHandler(t)},registerWidgetMessageModifier:function(e,t){R(e).registerMessageModifier(t)},sendMessageToWidget:function(e,t){R(e).sendMessage(t)},updateWixCodeModelDataAfterLogin:function(e,t){var i=e.getSiteData(),a=d.appsUtils.getApplications(i.getClientSpecMap(),t,i);P(e).updateWixCodeModelDataAfterLogin(a,t)}}}),define("widgets/core/WidgetAspect",["lodash","coreUtils","widgets/core/widgetDataHelper","widgets/core/widgetService","widgets/core/modelBuilderDataHelper"],function(e,t,i,a,n){"use strict";function s(t){this._siteAPI=t,this._siteAPI.updateAspectGlobalData(d,{loadedAppsRoots:[]}),this._updateSiteCallBacks=[],this._updating=!1,a.createAndRegisterWidgetHandler(t,this.updateSite.bind(this)),this._siteAPI.registerToSiteWillMount(o.bind(this)),this._siteAPI.registerToSiteWillUpdate(o.bind(this)),this._siteAPI.getRuntimeDal().registerChangeListener(e.partial(a.handleRuntimeDalCompChange,this._siteAPI)),this._siteAPI.getSiteDataAPI().registerDisplayedJsonUpdateCallback(e.partial(a.handleDisplayedJsonUpdate,this._siteAPI)),this._siteAPI.registerToFakeModeChange(e.partial(a.updateCompsUnderRoot,this._siteAPI)),this._siteAPI.registerClientSpecMapUpdateCallback(e.partial(a.handleSiteMemberUpdate,this._siteAPI)),this._siteAPI.registerToSvSessionChange(e.partial(a.handleSvSessionUpdate,this._siteAPI)),this.getWidgetHandler=e.partial(a.getWidgetHandler,this._siteAPI)}function o(){var e=this._siteAPI.getAspectGlobalData(d).loadedAppsRoots;this._siteAPI.updateAspectGlobalData(d,{loadedAppsRoots:a.syncAppsState(this._siteAPI,e)})}function r(t,i,a){return"masterPage"!==t?t:e.find(i,function(e){var t=a.getDataByQuery(e);return n.getWidgetType(t)===n.WIDGET_TYPES.PAGE})}var d="WidgetAspect";return s.prototype.init=function(){this._siteAPI.updateAspectGlobalData(d,{loadedAppsRoots:[]}),this._updateSiteCallBacks=[],this._updating=!1},s.prototype.updateSite=function(i){if(i&&this._updateSiteCallBacks.push(i),!this._updating){this._updating=!0;var a=this;t.animationFrame.request(function(){a._updating=!1,e.invokeMap(a._updateSiteCallBacks,e.call),a._updateSiteCallBacks=[]})}},s.prototype.allContextsReady=function(){var t=this._siteAPI.getAspectGlobalData(d).loadedAppsRoots;return e(t).map("rootId").every(this.isContextReady.bind(this))},s.prototype.isContextReady=function(t){var a=this._siteAPI.getSiteData(),n=a.widgetsStore,s=i.getWidgetHandler(n),o=this._siteAPI.getAspectGlobalData(d).loadedAppsRoots,u=e.map(o,"rootId"),c=r(t,u,a);return!!e.isEmpty(o)||e.includes(u,c)&&s.isWidgetReady(c)},s.prototype.loadUserCode=function(e){a.loadUserCode(this._siteAPI,e)},s.prototype.updateWixCodeModelDataAfterLogin=function(){var t=this._siteAPI.getAspectGlobalData(d).loadedAppsRoots;if(!e.isEmpty(t)){var i=e.map(t,"rootId");a.updateWixCodeModelDataAfterLogin(this._siteAPI,i)}},s.prototype.loadApps=function(e){if(this._siteAPI.getRenderFlag("initWixCode")){a.loadUserCode(this._siteAPI,e);var t=this._siteAPI.getAspectGlobalData(d).loadedAppsRoots;this._siteAPI.updateAspectGlobalData(d,{loadedAppsRoots:a.loadApps(this._siteAPI,t,e)})}},s.prototype.initApps=function(e){this._siteAPI.getRenderFlag("initWixCode")&&a.initApps(this._siteAPI,e)},s.prototype.stopApps=function(e){var t=this._siteAPI.getAspectGlobalData(d).loadedAppsRoots;this._siteAPI.updateAspectGlobalData(d,{loadedAppsRoots:a.stopApps(this._siteAPI,t,e)})},s.prototype.restartApps=function(){var t=this._siteAPI.getAspectGlobalData(d).loadedAppsRoots;if(!e.isEmpty(t)){var i=e.map(t,"rootId");this.stopApps(i),this.loadApps(i),this.initApps(i)}},s}),define("widgets/behaviors/widgetBehaviorHandler",["lodash"],function(e){"use strict";var t=["type","name","targetId"];return{handle:function(t,i,a){var n=i.getSiteAspect("WidgetAspect").getWidgetHandler();e.forEach(t,function(e){n.handleEvent(e.targetId,e.name,e.params,a)})},getUniqueIdentifier:function(i){var a=e.at(i,t);return a.push(i.params.callbackId),a.push(i.params.compId),a.join(",")}}}),define("widgets/behaviors/widgetBehaviorPreprocessor",["lodash"],function(e){"use strict";function t(e,t){var i=e.getRuntimeDal().getPageId(t);return i?"masterPage"===i?e.getSiteData().getFocusedRootId():i:null}return function(i,a,n){return e.assign({},i,{targetId:t(n,a.sourceId)})}}),define("widgets",["core","widgets/utils/wixCodeRemoteModelService","widgets/core/WidgetAspect","widgets/core/widgetDataHelper","widgets/core/modelBuilder","widgets/behaviors/widgetBehaviorHandler","widgets/behaviors/widgetBehaviorPreprocessor","widgets/messages/messageBuilder","widgets/utils/widgetModel","widgets/core/widgetService"],function(e,t,i,a,n,s,o,r,d,u){"use strict";return e.behaviorHandlersFactory.registerHandler("widget",s),e.behaviorHandlersFactory.registerBehaviorPreprocessor("widget",o),e.siteAspectsRegistry.registerSiteAspect("WidgetAspect",i),{wixCodeRemoteModelService:t,widgetDataHelper:a,messageBuilder:r,modelBuilder:n,widgetModel:d,widgetService:u}});
//# sourceMappingURL=widgets.min.js.map